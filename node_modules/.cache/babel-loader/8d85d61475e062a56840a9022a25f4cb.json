{"ast":null,"code":"import _toConsumableArray from\"/Users/pavankoushik/Downloads/mern-discord-clone/frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import store from\"../store/store\";import{setLocalStream,setRemoteStreams}from\"../store/actions/roomActions\";import Peer from\"simple-peer\";import*as socketConnection from\"./socketConnection\";var getConfiguration=function getConfiguration(){var turnIceServers=null;// we need third party service for turnserver. Use this if you want to deploy\nif(turnIceServers){// TODO use TURN server credentials\n}else{console.warn(\"Using only STUN server\");return{iceServers:[{urls:\"stun:stun.l.google.com:19302\"}]};}};var onlyAudioConstraints={audio:true,video:false};var defaultConstraints={video:true,audio:true};export var getLocalStreamPreview=function getLocalStreamPreview(){var onlyAudio=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var callbackFunc=arguments.length>1?arguments[1]:undefined;var constraints=onlyAudio?onlyAudioConstraints:defaultConstraints;// navigation.mediaDevices function is provided by browser\nnavigator.mediaDevices.getUserMedia(constraints).then(function(stream){store.dispatch(setLocalStream(stream));callbackFunc();}).catch(function(err){console.log(err);console.log(\"Cannot get an access to local stream\");});};var peers={};export var prepareNewPeerConnection=function prepareNewPeerConnection(connUserSocketId,isInitiator){var localStream=store.getState().room.localStream;if(isInitiator){console.log(\"preparing new peer connection as initiator\");}else{console.log(\"preparing new peer connection as not initiator\");}peers[connUserSocketId]=new Peer({initiator:isInitiator,config:getConfiguration(),stream:localStream});peers[connUserSocketId].on(\"signal\",function(data){var signalData={signal:data,connUserSocketId:connUserSocketId};socketConnection.signalPeerData(signalData);});peers[connUserSocketId].on(\"stream\",function(remoteStream){console.log(\"remote stream came from other user\");console.log(\"direct connection has been established\");remoteStream.connUserSocketId=connUserSocketId;addNewRemoteStream(remoteStream);});};export var handleSignalingData=function handleSignalingData(data){var connUserSocketId=data.connUserSocketId,signal=data.signal;if(peers[connUserSocketId]){peers[connUserSocketId].signal(signal);}};var addNewRemoteStream=function addNewRemoteStream(remoteStream){var remoteStreams=store.getState().room.remoteStreams;var newRemoteStreams=[].concat(_toConsumableArray(remoteStreams),[remoteStream]);store.dispatch(setRemoteStreams(newRemoteStreams));};export var closeAllConnections=function closeAllConnections(){Object.entries(peers).forEach(function(mappedObject){var connUserSocketId=mappedObject[0];if(peers[connUserSocketId]){peers[connUserSocketId].destroy();delete peers[connUserSocketId];}});};export var handleParticipantLeftRoom=function handleParticipantLeftRoom(data){var connUserSocketId=data.connUserSocketId;if(peers[connUserSocketId]){peers[connUserSocketId].destroy();delete peers[connUserSocketId];}var remoteStreams=store.getState().room.remoteStreams;var newRemoteStreams=remoteStreams.filter(function(remoteStream){return remoteStream.connUserSocketId!==connUserSocketId;});store.dispatch(setRemoteStreams(newRemoteStreams));};export var switchOutgoingTracks=function switchOutgoingTracks(stream){for(var socket_id in peers){for(var index in peers[socket_id].streams[0].getTracks()){for(var index2 in stream.getTracks()){if(peers[socket_id].streams[0].getTracks()[index].kind===stream.getTracks()[index2].kind){peers[socket_id].replaceTrack(peers[socket_id].streams[0].getTracks()[index],stream.getTracks()[index2],peers[socket_id].streams[0]);break;}}}}};","map":{"version":3,"names":["store","setLocalStream","setRemoteStreams","Peer","socketConnection","getConfiguration","turnIceServers","console","warn","iceServers","urls","onlyAudioConstraints","audio","video","defaultConstraints","getLocalStreamPreview","onlyAudio","callbackFunc","constraints","navigator","mediaDevices","getUserMedia","then","stream","dispatch","catch","err","log","peers","prepareNewPeerConnection","connUserSocketId","isInitiator","localStream","getState","room","initiator","config","on","data","signalData","signal","signalPeerData","remoteStream","addNewRemoteStream","handleSignalingData","remoteStreams","newRemoteStreams","closeAllConnections","Object","entries","forEach","mappedObject","destroy","handleParticipantLeftRoom","filter","switchOutgoingTracks","socket_id","index","streams","getTracks","index2","kind","replaceTrack"],"sources":["/Users/pavankoushik/Downloads/mern-discord-clone/frontend/src/realtimeCommunication/webRTCHandler.js"],"sourcesContent":["import store from \"../store/store\";\nimport { setLocalStream, setRemoteStreams } from \"../store/actions/roomActions\";\nimport Peer from \"simple-peer\";\nimport * as socketConnection from \"./socketConnection\";\n\nconst getConfiguration = () => {\n  const turnIceServers = null;\n\n  // we need third party service for turnserver. Use this if you want to deploy\n  if (turnIceServers) {\n    // TODO use TURN server credentials\n  } else {\n    console.warn(\"Using only STUN server\");\n    return {\n      iceServers: [\n        {\n          urls: \"stun:stun.l.google.com:19302\",\n        },\n      ],\n    };\n  }\n};\n\nconst onlyAudioConstraints = {\n  audio: true,\n  video: false,\n};\n\nconst defaultConstraints = {\n  video: true,\n  audio: true,\n};\n\nexport const getLocalStreamPreview = (onlyAudio = false, callbackFunc) => {\n  const constraints = onlyAudio ? onlyAudioConstraints : defaultConstraints;\n\n  // navigation.mediaDevices function is provided by browser\n  navigator.mediaDevices\n    .getUserMedia(constraints)\n    .then((stream) => {\n      store.dispatch(setLocalStream(stream));\n      callbackFunc();\n    })\n    .catch((err) => {\n      console.log(err);\n      console.log(\"Cannot get an access to local stream\");\n    });\n};\n\nlet peers = {};\n\nexport const prepareNewPeerConnection = (connUserSocketId, isInitiator) => {\n  const localStream = store.getState().room.localStream;\n\n  if (isInitiator) {\n    console.log(\"preparing new peer connection as initiator\");\n  } else {\n    console.log(\"preparing new peer connection as not initiator\");\n  }\n\n  peers[connUserSocketId] = new Peer({\n    initiator: isInitiator,\n    config: getConfiguration(),\n    stream: localStream,\n  });\n\n  peers[connUserSocketId].on(\"signal\", (data) => {\n    const signalData = {\n      signal: data,\n      connUserSocketId: connUserSocketId,\n    };\n\n    socketConnection.signalPeerData(signalData);\n  });\n\n  peers[connUserSocketId].on(\"stream\", (remoteStream) => {\n    console.log(\"remote stream came from other user\");\n    console.log(\"direct connection has been established\");\n    remoteStream.connUserSocketId = connUserSocketId;\n    addNewRemoteStream(remoteStream);\n  });\n};\n\nexport const handleSignalingData = (data) => {\n  const { connUserSocketId, signal } = data;\n\n  if (peers[connUserSocketId]) {\n    peers[connUserSocketId].signal(signal);\n  }\n};\n\nconst addNewRemoteStream = (remoteStream) => {\n  const remoteStreams = store.getState().room.remoteStreams;\n  const newRemoteStreams = [...remoteStreams, remoteStream];\n\n  store.dispatch(setRemoteStreams(newRemoteStreams));\n};\n\nexport const closeAllConnections = () => {\n  Object.entries(peers).forEach((mappedObject) => {\n    const connUserSocketId = mappedObject[0];\n    if (peers[connUserSocketId]) {\n      peers[connUserSocketId].destroy();\n      delete peers[connUserSocketId];\n    }\n  });\n};\n\nexport const handleParticipantLeftRoom = (data) => {\n  const { connUserSocketId } = data;\n\n  if (peers[connUserSocketId]) {\n    peers[connUserSocketId].destroy();\n    delete peers[connUserSocketId];\n  }\n\n  const remoteStreams = store.getState().room.remoteStreams;\n\n  const newRemoteStreams = remoteStreams.filter(\n    (remoteStream) => remoteStream.connUserSocketId !== connUserSocketId\n  );\n\n  store.dispatch(setRemoteStreams(newRemoteStreams));\n};\n\nexport const switchOutgoingTracks = (stream) => {\n  for (let socket_id in peers) {\n    for (let index in peers[socket_id].streams[0].getTracks()) {\n      for (let index2 in stream.getTracks()) {\n        if (\n          peers[socket_id].streams[0].getTracks()[index].kind ===\n          stream.getTracks()[index2].kind\n        ) {\n          peers[socket_id].replaceTrack(\n            peers[socket_id].streams[0].getTracks()[index],\n            stream.getTracks()[index2],\n            peers[socket_id].streams[0]\n          );\n          break;\n        }\n      }\n    }\n  }\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}